<html>

  <head>
      <meta name="twitter:card" content="photo">
  <meta name="twitter:site" content="@cabbibo">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:url" content="http://cabbi.bo">
  <meta name="twitter:title" content="Long Live Synesthesia">
  <meta name="twitter:description" content="Long Live Synesthesia">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:image" content="http://cabbi.bo/image.png">
  <meta name="twitter:image:width" content="1440">
  <meta name="twitter:image:height" content="900">
  <meta name="twitter:domain" content="cabbi.bo">
  <meta itemprop="name" content="Cabbi.bo">
  <meta itemprop="description" content="Long Live Synesthesia">
  <meta itemprop="image" src="http://cabbi.bo/image.png">
  <meta property="og:title" content="Cabbi.bo">
  <meta property="og:type" content="website">
  <meta property="og:image" content="http://cabbi.bo/image.png"/>
  <meta property="og:site_name" content="Cabbi.bo">
  <meta property="og:description" content="Long Live Synesthesia">

  <style>

    @font-face {
      font-family: "GeoSans";
      src: url("lib/GeosansLight.ttf");
    }
    html{ color:#fff; background:#000000; font-family:"GeoSans" }

    #container{
      //width      : 100%;
      //height     : 100%;
      position   : absolute;
      top        : 100px;
      left       : 0px;
      background : #000;
    }

    #renderer{

      -webkit-box-shadow: inset 0px 0px 33px 0px rgba(0,0,0,0.83);
-moz-box-shadow: inset 0px 0px 33px 0px rgba(0,0,0,0.83);
box-shadow: inset 0px 0px 33px 0px rgba(0,0,0,0.83);

    }

    #stats{
      position  : absolute;
      bottom    : 0px;
      right     : 0px;
      z-index   : 999;
    }

    a{
      color: #fff;
      text-decoration: none;
      opacity:.6;
      //position: absolute;
     // z-index: 999;
   }

   a:hover{
    opacity:1;
   }

    #loading{

      width:100%;
      text-align:center;
      padding-top:100px;
      font-size:25px;

    }

    #GUI{

      position:fixed;
      top:0px;
      right:0px;
      z-index:999;
      display:none;

    }

    h1{

      margin:0px;
      padding:10px;
    }
    #share{
      cursor: hand;
      //position: absolute;
      position: fixed;
      z-index: 99;
      font-size: 55px;

      top: 100px;
     /* left:70px;
      font-size: 25px;
      padding: 10px;*/
       left: 50%;
    -webkit-transform: translate(-50%, -120%);
    transform: translate(-50%, -120%);
    text-decoration:none;
    opacity:.6

  }
  #share:hover{
    opacity:1
  }



    #tweet{

      position:absolute;
      z-index:999;
      right:100px;
      bottom: 25px;
      opacity:.6;

    }
     #tweet:hover{


      opacity: 1;

    }

    #tweet img{

width: 50px;
height: 50px;


    }

     #tweet2{

      position:absolute;
      z-index:999;
      right:25px;
      bottom: 25px;
      opacity:.6;

    }
     #tweet2:hover{


      opacity: 1;

    }

    #tweet2 img{

width: 50px;
height: 50px;


    }

    #nextColor{


z-index: 999;
font-size: 53.5px;
opacity: .6;
text-decoration: underline;

    }

    #nextColor:hover{
      opacity:1
    }

    #loadBar{

      position:absolute;
      top:100px;
      left:0px;
      height: 2px;
      opacity: .7;
      width: 10px;
      background:#fff;
      display:block;
      z-index:999;
    }


    #failure{

      position:absolute;
      left: 50%;
      top:50%;
      z-index:999;
      //border:1px solid white;
      font-size:30px;
      
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      display:none;
      text-align:center;
        
    }

  </style>
</head>
<body>

  <div id="loadBar"></div>

  <div id="failure">
    To view this Experiment,<br/>
    You will need the following:<br/><br/>

  </div>

  <div id="share">

    <!--<a id="nextColor" onclick="nextScheme()">Change Colors</a><br/>-->
    <a href="http://c418.bandcamp.com/album/one" target="_blank"> C418 - ONE </a><br/>

  </div>
  <a id="tweet" href="http://twitter.com/share?text=%23threejs%20visualizer%20made%20for%20the%20coolest%20dude%20on%20the%20planet:%20@C418%20(%20code:%20@cabbibo%20):%20&url=http://cabbi.bo/c418" target="_blank"><img src="tweet.png"/><br/>
     <a id="tweet2" href="http://cabbi.bo" target="_blank"><img src="cabbibo.png"/><br/>

  <div id="GUI"></div>
<script src = "lib/underscore.js"             ></script>
<script src = "lib/three.min.js"                  ></script>
<script src = "lib/jquery.min.js"             ></script>
<script src = "lib/stats.min.js"              ></script>
<script src = "lib/TrackballControls.js"      ></script>
<script src = "lib/ShaderLoader.js"           ></script>
<script src = "lib/OBJLoader.js"              ></script>
<script src = "lib/Stream.js"                 ></script>
<script src = "lib/AudioController.js"        ></script>
<script src = "lib/UserAudio.js"              ></script>
<script src = "lib/AudioTexture.js"           ></script>
<script src = "lib/dat.gui.min.js"            ></script>
<script src = "lib/leap.min.js"               ></script>
<script src = "lib/LeapTrackballControls.js"  ></script>
<script src = "lib/GUI.js"                    ></script>
<script src = "lib/SubdivisionModifier.js"    ></script>
<script src = "lib/addSocialMedia.js"         ></script>
<script src = "lib/Detector.js"               ></script>


<script src = "CubeObj.js"                ></script>

<script>

  var check = new Detector([
    "webGL",
    "mobile",
    "audio"
  ],function(F){

    var d = document.getElementById('failure');

    d.style.display="block"
    for( var i = 0; i < F.length; i++ ){

      var a = document.createElement('a' );
      a.href=F[i][1];
      a.innerHTML = F[i][0]+"<br/>";
      d.appendChild( a );


    }

  });
  var container , camera, scene, renderer , stats;

  var sceneSize = 5000;

  var andersGeo;
  var loaded = 0;
  var neededToLoad = 2;

  var clock = new THREE.Clock();

  var audioController = new AudioController();

///audioController.mute.gain.value = 0;

/* var userAudio = new UserAudio( audioController );
 userAudio.onStreamCreated = function(){

   onLoad();

   console.log('HEKLKS');

 }
*/

 var stream = new Stream( 'one.mp3', audioController  );
 
  var mossNormal = THREE.ImageUtils.loadTexture( 'img/normals/moss_normal_map.jpg' )  
  mossNormal.wrapS = THREE.RepeatWrapping; 
  mossNormal.wrapT = THREE.RepeatWrapping; 

  var sprite = THREE.ImageUtils.loadTexture( 'img/cabbibo.png' )  

 var G = {

   resolution: { type:"v2" , value: new THREE.Vector2( window.innerWidth , window.innerHeight ) },
   t_audio : { type:"t" , value: audioController.texture },
   t_normal: { type:"t" , value: mossNormal},
   t_sprite: { type:"t" , value: sprite},

   
    time:{ type:"f" , value:0 },
    dT:{ type:"f" , value:0 },
    lightPos:{type:"v3",value: new THREE.Vector3( 200 , 0 , 0 ) },

    numOfCubes:{type:"f" , value: 3000 },
        
    tmp_cubeOut:   { type:"color"  , value:                  0xF2B66D },
    cubeOut:       { type:"c"      , value: new THREE.Color( 0xF2B66D )},  

    tmp_cubeIn:    { type:"color"  , value:                  0xB0844F },
    cubeIn:        { type:"c"      , value: new THREE.Color( 0xB0844F )},  

    tmp_handOut:  { type:"color"  , value:                  0x059372 },
    handOut:      { type:"c"      , value: new THREE.Color( 0x059372 )},  

    tmp_handIn:   { type:"color"  , value:                  0x7ec7a0 },
    handIn:       { type:"c"      , value: new THREE.Color( 0x7ec7a0 )}, 

    tmp_particlesOut: { type:"color"  , value:                  0xBF533B },
    particlesOut:     { type:"c"      , value: new THREE.Color( 0xBF533B )},  

    tmp_particlesIn:  { type:"color"  , value:                  0xA84934 },
    particlesIn:      { type:"c"      , value: new THREE.Color( 0xA84934 )}, 

    tmp_bg: { type:"color"  , value:                  0x281000 },
    bg:     { type:"c"      , value: new THREE.Color( 0x281000 )},  


  }

   function assignColors( array ){

     G.tmp_cubeOut.value = array[0];
     G.cubeOut.value.setHex( array[0] );

     G.tmp_cubeIn.value = array[1];
     G.cubeIn.value.setHex( array[1] );

     G.tmp_handOut.value = array[2];
     G.handOut.value.setHex( array[2] );

     G.tmp_handIn.value = array[3];
     G.handIn.value.setHex( array[3] );

     G.tmp_particlesOut.value = array[4];
     G.particlesOut.value.setHex( array[4] );

     G.tmp_particlesIn.value = array[5];
     G.particlesIn.value.setHex( array[5] );

     G.tmp_bg.value = array[6];
     G.bg.value.setHex( array[6] );

     if( renderer ){
       renderer.setClearColor( array[6] , 1 );
     }





   }

   function nextScheme(){

     currentScheme ++;
     currentScheme %= colorSchemes.length;

     assignColors( colorSchemes[ currentScheme ] );




   }




   colorSchemes = [
[ 
0xFA9600,
0xFABD4A,
0xF73E47,
0x47FADB,
0xffffff,
0xffffff,
0x000000,
],

[
   0xFF845B,
   0x5affff,
   0xff5ad8,
   0x5b7bff,
   0x5BFFB0,
   0xffffff,
   0x000000
  ],
  [
    0x96CEB4,
    0xFFEEAD,
    0xFF6F69,
    0xFFCC5C,
    0xAAD8B0,
    0xFF6F69,
    0x000000
  ],

  [
  
    0xEFC94C,
    0x334D5C,
    0x45B29D,
    0xEFC94C,
    0xE27A3F,
    0xDF5A49,
     0x000000
    ]

]

   var currentScheme = colorSchemes.length-1;

  nextScheme();

  var controller = new Leap.Controller();
  controller.connect();

 
  var loadBar = document.getElementById( 'loadBar' );
  console.log( 'LAIOD');
  console.log( loadBar );
  

  var loader  = new THREE.OBJLoader();
  loader.load( 'models/hand.obj' , function( obj ){

    handGeo = obj.children[0].geometry;
    handGeo.computeFaceNormals();
    handGeo.computeVertexNormals();
    console.log('geo done');
    onLoad();


  },function( a ){

  var percent = (a.loaded / a.total);
  loadBar.style.width = percent * window.innerWidth + "px"
  console.log('ROAS');
  console.log( a ); 
  
  },function(){

    alert( 'ERROR LOADING HAND' );
    
  });

 

  var shaders = new ShaderLoader('shaders');

 /* shaders.load( 'fs-cross' , 'cross' , 'fragment' );
  shaders.load( 'vs-cross' , 'cross' , 'vertex' );
  shaders.load( 'fs-box' , 'box' , 'fragment' );
  shaders.load( 'vs-box' , 'box' , 'vertex' );
  
  shaders.load( 'fs-skull' , 'skull' , 'fragment' );
  shaders.load( 'vs-skull' , 'skull' , 'vertex' );
  */


  shaders.load( 'fs-hand' , 'hand' , 'fragment' );
  shaders.load( 'vs-hand' , 'hand' , 'vertex' );

  shaders.load( 'fs-cube' , 'cube' , 'fragment' );
  shaders.load( 'vs-cube' , 'cube' , 'vertex' );

  shaders.load( 'fs-particles' , 'particles' , 'fragment' );
  shaders.load( 'vs-particles' , 'particles' , 'vertex' );

  shaders.shaderSetLoaded = function(){
   onLoad();
  }


  
  function init(){


    
    
    // Getting the container in the right location
    container     = document.createElement( 'div' );
    container.id  = 'container';
    
    document.body.appendChild( container );

    // Getting the stats in the right position
    stats = new Stats();
    stats.domElement.id = 'stats';
    //document.body.appendChild( stats.domElement );


    // Setting up our Renderer
    renderer = new THREE.WebGLRenderer({
      antialias:true 
    });
    renderer.setClearColor( G.tmp_bg.value, 1 );

    renderer.setSize( window.innerWidth, window.innerHeight -200);
    container.appendChild( renderer.domElement );

   renderer.domElement.id="renderer"
    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera( 
      70 ,
      window.innerWidth / (window.innerHeight-200),
      1 / 10 ,
      4000
    );

    // placing our camera position so it can see everything
   // camera.position.z = 50;
    camera.position.set( -575 , -46 , 351.1085905952933 );

     camera.position.set( -1046, 401, -221.);
    camera.velocity = new THREE.Vector3();

    fallback = new THREE.TrackballControls( camera , renderer.domElement );
    fallback.maxDistance = 2000; 
    fallback.minDistance = 50; 
    controls = new THREE.LeapTrackballControls( camera , controller , fallback );

    controls.zoom = 1000;
    controls.maxZoom = 2000;
    controls.minZoom = 50;
    controls.zoomDampening = .95;
    controls.zoomMultiplier = 10;
    controls.rotationSpeed = 3;
    controls.rotationDampening = .95;

 
    // Making sure our renderer is always the right size
    window.addEventListener( 'resize', onWindowResize , false );
    window.addEventListener( 'keydown', onKeyDown , false );


    mover = new THREE.Object3D();

    scene.add( mover );
    
  
    
    handMat = new THREE.ShaderMaterial({


      uniforms:G,
      vertexShader: shaders.vs.hand,
      fragmentShader: shaders.fs.hand,
      side: THREE.DoubleSide,
      transparent: true,
      shading: THREE.SmoothShading

    });

  // var modifier = new THREE.SubdivisionModifier( 3 );
    //  modifier.modify( geo );

    handGeo.computeFaceNormals();
    handGeo.computeVertexNormals();
    hand = new THREE.Mesh(
      handGeo,
      handMat 
    );

    hand.scale.multiplyScalar( 200 );

    mover.add( hand );

    
  
    
    var cubeGeo = new CubeObj(G.numOfCubes.value);

    console.log( cubeGeo );

    var cubeMat = new THREE.ShaderMaterial({
      uniforms:G,
      attributes:{
        centerPosition:{type:"v3",value:null},
        id:{type:"float",value:null},
      },
      vertexShader: shaders.vs.cube,
      fragmentShader: shaders.fs.cube,
      side: THREE.DoubleSide,
      //transparent: true
    });

  var cubes = new THREE.Object3D();

  for( var i =0; i < 4; i++ ){


    var cube = new THREE.Mesh( cubeGeo , cubeMat );
    cube.rotation.y = (i / 4 ) * 2 * Math.PI;
    cubes.add( cube );

     var cube = new THREE.Mesh( cubeGeo , cubeMat );
     cube.rotation.y = (i / 4 ) * 2 * Math.PI;
     cube.rotation.z = Math.PI;
     cubes.add( cube );

     /*   var cube = new THREE.Mesh( cubeGeo , cubeMat );
     cube.rotation.y = (i / 4 ) * 2 * Math.PI;
     cube.rotation.z = Math.PI;
     cube.rotation.x = Math.PI;*/

     /*  var cube = new THREE.Mesh( cubeGeo , cubeMat );
     cube.rotation.y = (i / 4 ) * 2 * Math.PI;
     cube.rotation.z = Math.PI;*/
    /// cube.rotation.x = Math.PI;
    cubes.add( cube );

  
  }
  cubes.scale.multiplyScalar( 2 );

  mover.add( cubes );

  var particles = new THREE.Object3D();

  var particleMat = new THREE.ShaderMaterial({
    uniforms:G,
    attributes:{
      centerPosition:{type:"v3",value:null},
      id:{type:"float",value:null},
    },
    vertexShader: shaders.vs.particles,
    fragmentShader: shaders.fs.particles,
    transparent: true,
    blending: THREE.AdditiveBlending,
    //depthWrite:false
  });
  for( var i =0; i < 4; i++ ){


    var particle = new THREE.PointCloud( cubeGeo , particleMat );
    particle.rotation.y = (i / 4 ) * 2 * Math.PI;
    particles.add( particle );

    var particle = new THREE.PointCloud( cubeGeo , particleMat );
    particle.rotation.y = (i / 4 ) * 2 * Math.PI;
    particle.rotation.x = Math.PI;
    particles.add( particle );

     

    particles.add( particle );

  
  }
 
  particles.scale.multiplyScalar( 40 );
  particles.rotation.z = Math.PI;

  mover.add( particles );







  /* var cubeGeo = new CubeObj();

    console.log( cubeGeo );*/

    /*var cube = new THREE.Mesh( cubeGeo , new THREE.MeshNormalMaterial({
     side: THREE.DoubleSide 
   }) );

   cube.scale.multiplyScalar( 10 );
    mover.add( cube )*/


 
    gem = cube;

    var gHolder = document.createElement('div');

    var tHolder = document.createElement('h1');

    tHolder.innerHTML ='COLOR';
    tHolder.style.background = 'black';
    gHolder.appendChild( tHolder );
    var guis = document.getElementById( 'GUI' );

    guis.appendChild( gHolder );

  /*  $(tHolder).click(function(){
      this.toggle();
      if( this.active ){
        this.tHolder.className = "active";
      }else{
        this.tHolder.className = "";
      }
    }.bind( gem ));*/


    $(tHolder).hover(function(){
      this.gui.gui.open();
    }.bind( gem ));

    $(gHolder).hover(function(){},function(){
      this.gui.gui.close();
    }.bind(gem));

    gem.tHolder = tHolder;

    gem.gui = new GUI( G , {
     domElement: gHolder 
    });

    //console.log( source );
    
   /* if( source.mediaElement ){
      source.mediaElement.play();
    }else{

      audio.play();

    }*/

    camera.position.set( 
      385.1791848900996,
      448.95662259266834, 
      -325.71949426983144
    );
     camera.position.set( 0, 0, 51.);

     camera.up.set( 0,1,1);

     stream.play();


         loadBar.style.display = "none";

  }


  function animate(){

    audioController.update();

    G.dT.value = clock.getDelta();
    G.time.value += G.dT.value;

    var norm = camera.position.clone().normalize();
    norm.multiplyScalar( Math.PI * 2 );
   
   // crownMat.uniforms.texScale.value = .1 * Math.sin( norm.x ) * Math.cos( norm.y );
   // crownMat.uniforms.normalScale.value = 1. + Math.sin( norm.z )

    stats.update();

    controls.update();
    renderer.render( scene , camera );

    requestAnimationFrame( animate );

   /* for( var i = 0; i < meshes.length; i++ ){

      var a = audioController.analyzer.array[i]
      meshes[i].velocity.y += .001;
      meshes[i].position.add( meshes[i].velocity.clone().multiplyScalar( (.5 + .1 *a*a/256) ) );
      if( meshes[i].position.y >= 350 ){

        meshes[i].position.y = -150;
        meshes[i].velocity.y = 0;

      }



      var y =Math.abs(( meshes[i].position.y - 400) / 500);
      var s =  (.5 + 2 *(a*a)/65536)*y;
      meshes[i].scale.set( s, s, s);
      
      
      
      meshes[i].rotation.x += .0001 *(100+ a);
      meshes[i].rotation.y += .000133 *(100+ a);
      meshes[i].rotation.z += .000145 *(100+ a);

    }

    var p = camera.position.clone();
    p.normalize();

    box.rotation.x = Math.abs( Math.cos( p.x )*3 );
    box.rotation.y = Math.abs( Math.cos( p.y )*3 );
    box.rotation.z = Math.abs( Math.cos( p.z )*3 );
*/
  }

  // Resets the renderer to be the proper size
  function onWindowResize(){

    G.resolution.value.set( window.innerWidth , (window.innerHeight-200) );
    camera.aspect = window.innerWidth / (window.innerHeight-200);
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, (window.innerHeight-200) );

  }

  function onKeyDown( e ){

    console.log( e );

    if( e.keyCode == 32 ){

      nextScheme();

    }
  }

  function onLoad(){


    loaded ++;

    if( loaded === neededToLoad ){

      init();
      animate();
      //stream.play();

    }

  }


 
</script>


</body>
</html>
